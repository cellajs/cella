import type { UserConfig } from '@hey-api/openapi-ts';
import { defineConfig } from '@hey-api/openapi-ts';
import { defineConfig as openapiParserPlugin } from './vite/openapi-parser';
import { defineConfig as tsdocPlugin } from './vite/tsdoc-plugin';

/**
 * OpenAPI TS configuration for generating the frontend API client.
 *
 * The input is a cached OpenAPI JSON generated by the backend.
 *
 * The `output.path` defined here is the final destination.
 * The `generate-client.ts` script overrides this to generate to a temp folder first,
 * then compares output and only updates `src/api.gen` on actual changes.
 * This prevents unnecessary file modifications and HMR triggers.
 *
 * @see ./vite/openapi-watch-mode.ts - Dev server file watcher
 * @see ./vite/generate-client.ts - Incremental generation wrapper
 */
export const openApiConfig: UserConfig = {
  input: {
    path: '../backend/openapi.cache.json',
    watch: false,
  },
  output: {
    path: './src/api.gen',
    source: {
      fileName: 'openapi',
      path: '../../public/static',
    },
  },
  parser: {
    transforms: {
      readWrite: false,
    },
  },
  plugins: [
    tsdocPlugin(),
    openapiParserPlugin(),
    'zod',
    { name: '@hey-api/sdk', responseStyle: 'data' },
    {
      name: '@hey-api/client-fetch',
      throwOnError: true,
      runtimeConfigPath: '../api-config',
    },
  ],
};

export default defineConfig(openApiConfig);
