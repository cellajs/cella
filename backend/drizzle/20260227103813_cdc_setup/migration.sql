-- ⚠️ AUTO-GENERATED — DO NOT EDIT THIS FILE DIRECTLY
-- This migration is generated by a script in backend/scripts/migrations/.
-- To make changes, edit the generator script and re-run it.
-- The user will handle migration generation and application.
--
-- CDC (Change Data Capture) Setup
-- Sets up PostgreSQL logical replication for the activities CDC worker.
-- Requires: wal_level=logical (see compose.yaml)
-- For PGlite/environments without logical replication: migration is skipped.

DO $$
BEGIN
  -- Check if pg_publication is available (not available in PGlite)
  IF NOT EXISTS (SELECT 1 FROM pg_catalog.pg_class WHERE relname = 'pg_publication') THEN
    RAISE NOTICE 'Logical replication not available - skipping CDC setup (e.g., PGlite).';
    RETURN;
  END IF;

  -- 1. Create or update publication
  BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_publication WHERE pubname = 'cdc_pub') THEN
      CREATE PUBLICATION cdc_pub FOR TABLE users, organizations, attachments, pages, requests, memberships, inactive_memberships;
      RAISE NOTICE 'Created publication cdc_pub';
    ELSE
      -- Publication exists — ensure all tracked tables are included
      RAISE NOTICE 'Publication cdc_pub already exists, syncing tables...';
      BEGIN ALTER PUBLICATION cdc_pub ADD TABLE users; EXCEPTION WHEN duplicate_object THEN NULL; END;
      BEGIN ALTER PUBLICATION cdc_pub ADD TABLE organizations; EXCEPTION WHEN duplicate_object THEN NULL; END;
      BEGIN ALTER PUBLICATION cdc_pub ADD TABLE attachments; EXCEPTION WHEN duplicate_object THEN NULL; END;
      BEGIN ALTER PUBLICATION cdc_pub ADD TABLE pages; EXCEPTION WHEN duplicate_object THEN NULL; END;
      BEGIN ALTER PUBLICATION cdc_pub ADD TABLE requests; EXCEPTION WHEN duplicate_object THEN NULL; END;
      BEGIN ALTER PUBLICATION cdc_pub ADD TABLE memberships; EXCEPTION WHEN duplicate_object THEN NULL; END;
      BEGIN ALTER PUBLICATION cdc_pub ADD TABLE inactive_memberships; EXCEPTION WHEN duplicate_object THEN NULL; END;
      RAISE NOTICE 'Publication tables synced';
    END IF;
  EXCEPTION WHEN OTHERS THEN
    RAISE WARNING 'Publication setup failed: % (SQLSTATE: %)', SQLERRM, SQLSTATE;
  END;

  -- 2. Set REPLICA IDENTITY FULL (separate block)
  BEGIN
    ALTER TABLE users REPLICA IDENTITY FULL;
    ALTER TABLE organizations REPLICA IDENTITY FULL;
    ALTER TABLE attachments REPLICA IDENTITY FULL;
    ALTER TABLE pages REPLICA IDENTITY FULL;
    ALTER TABLE requests REPLICA IDENTITY FULL;
    ALTER TABLE memberships REPLICA IDENTITY FULL;
    ALTER TABLE inactive_memberships REPLICA IDENTITY FULL;
    RAISE NOTICE 'REPLICA IDENTITY FULL set on all tracked tables';
  EXCEPTION WHEN OTHERS THEN
    RAISE WARNING 'REPLICA IDENTITY setup failed: % (SQLSTATE: %)', SQLERRM, SQLSTATE;
  END;

  -- 3. Create replication slot (separate block - may fail on managed providers)
  BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_replication_slots WHERE slot_name = 'cdc_slot') THEN
      PERFORM pg_create_logical_replication_slot('cdc_slot', 'pgoutput');
      RAISE NOTICE 'Created replication slot cdc_slot';
    ELSE
      RAISE NOTICE 'Replication slot cdc_slot already exists';
    END IF;
  EXCEPTION WHEN OTHERS THEN
    RAISE WARNING 'Replication slot setup failed: % (SQLSTATE: %). Worker will create it at startup.', SQLERRM, SQLSTATE;
  END;

  RAISE NOTICE 'CDC setup complete.';
END $$;
