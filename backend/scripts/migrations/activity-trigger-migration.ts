/**
 * Generate Activity Notify Trigger Migration
 *
 * This script generates the PostgreSQL trigger that sends NOTIFY events
 * when activities are inserted. This powers the event bus in the backend.
 *
 * Usage:
 *   pnpm generate (runs as part of generate pipeline)
 *   tsx scripts/generate-activity-trigger.ts (standalone)
 */

import { logMigrationResult, upsertMigration } from './helpers/drizzle-utils';

const migrationSql = `-- Activity notification trigger for event bus
-- Generated by: generate-activity-trigger.ts
--
-- This trigger sends a pg_notify whenever a new activity is inserted,
-- allowing the backend to react to CDC-generated activities in real-time.

CREATE OR REPLACE FUNCTION notify_activity_insert()
RETURNS TRIGGER AS $$
BEGIN
  -- Notify with activity data as JSON payload
  PERFORM pg_notify('cella_activities', json_build_object(
    'id', NEW.id,
    'type', NEW.type,
    'action', NEW.action,
    'tableName', NEW.table_name,
    'entityType', NEW.entity_type,
    'resourceType', NEW.resource_type,
    'entityId', NEW.entity_id,
    'userId', NEW.user_id,
    'organizationId', NEW.organization_id,
    'changedKeys', NEW.changed_keys,
    'createdAt', NEW.created_at
  )::text);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Drop existing trigger if it exists (for idempotency)
DROP TRIGGER IF EXISTS activities_notify_trigger ON activities;

-- Create the trigger
CREATE TRIGGER activities_notify_trigger
AFTER INSERT ON activities
FOR EACH ROW EXECUTE FUNCTION notify_activity_insert();
`;

const result = upsertMigration('activity_notify_trigger', migrationSql);
logMigrationResult(result, 'Activity notify trigger');
