# Cella Agent Guidelines (AGENTS.md)

This document provides instructions and context for AI agents working on cella as a template, or on an app being built with cella as the tempalte.

## Project Vision
Cella is a TypeScript template for building collaborative web apps with sync and offline capabilities. OpenAPI is a central part of the architecture.

## Tech Stack
- **Backend**: Node.js (v24), Hono, Drizzle ORM, PostgreSQL (or PGlite for local dev), Scalar (API Docs).
- **Frontend**: React, TanStack Router, TanStack Query, Zustand, Shadcn UI, Tailwind CSS.
- **Tools**: Pnpm (workspaces), Biome (lint/format), Vitest (testing), Vite.
- **IDE Support**: Development with VSCode and WebStorm/JetBrains should be supported.  

## Architecture
- **Flat-root Monorepo**:
  - `backend/`: API, DB schemas, migrations, email templates.
  - `frontend/`: React SPA, generated API client, routes, modules.
  - `config/`: Shared configuration for different environments.
  - `locales/`: i18n translation files.
- **Modularity**: Code is organized into modules (e.g., `auth`, `users`, `organizations`) in both `backend/src/modules` and `frontend/src/modules`. Always maintain this structure when adding features.

## Routing
- **Backend (Hono + OpenAPI)**:
  - Routes are defined in `backend/src/modules/<module>/routes.ts` using `createXRoute`. This defines the OpenAPI specification (method, path, guard, request/response schemas).
  - Route handlers are implemented in `backend/src/modules/<module>/handlers.ts` using the `.openapi()` method on an `OpenAPIHono` instance.
  - All module handlers are aggregated in `backend/src/routes.ts`.
- **Frontend (TanStack Router)**:
  - Cella uses a **code-based** router organization, **NOT file-based**.
  - Routes are defined in `frontend/src/routes/` as `.tsx` files (e.g., `user-routes.tsx`) but must be manually added to the route tree.
  - They use `createRoute` and are explicitly organized into a tree structure in `frontend/src/routes/route-tree.tsx`.
  - Layouts (like `AppLayout` or `AuthLayout`) are defined in `frontend/src/routes/base-routes.tsx` and serve as parent routes.
  - The router instance is initialized in `frontend/src/lib/router.ts`.

## State Management & API
- **Server Data State**: Managed by **TanStack Query**. Query options and keys are defined in `frontend/src/modules/<module>/query.ts`. Optimistic updates are a core pattern.
- **Client State**: Managed by **Zustand**. Stores for UI state, user preferences, and global services (like toasts) are in `frontend/src/store/`.
- **API Client**: The frontend uses a client SDK generated by `openapi-ts` located in `frontend/src/api.gen/`. Always use this client for API calls.

## TypeScript
- **Backend**:
  - **Database**: Drizzle schemas are in `backend/src/db/schema/`.
  - **API Validation**: Zod schemas are in `backend/src/modules/<module>/schema.ts` (using `@hono/zod-openapi`).
  - **Circular Dependencies**: `schema-base.ts` files are used for shared base schemas to prevent circular imports.
  - Types are typically inferred from Zod schemas using `z.infer`.
- **Frontend**:
  - **Generated Types**: The source of truth for API types is `frontend/src/api.gen/`, generated by `openapi-ts` from the OpenAPI spec in `backend/openapi.yaml`.
  - **Module Types**: UI-specific types and extensions of generated types are in `frontend/src/modules/<module>/types.ts`.
  - Type assertions should be avoided.

## Development Rules & Constraints
- **API Client**: The frontend SDK in `frontend/src/api.gen/` is generated from the backend OpenAPI spec. **Never modify files in `api.gen` manually.** Run `pnpm generate:openapi` after changing backend routes or schemas.
- **Database**: Drizzle ORM is mandatory. Schema definitions are in `backend/src/db/schema/`. Use `pnpm generate` in the root or backend to create migrations.

## Coding Patterns
- **Entities**: Entities are categorized into `ContextEntityType` (has memberships, like organizations) and `ProductEntityType` (content-related). See `info/ARCHITECTURE.md` for details.
- **Environment**: Check `.env` and `config/default.ts` for configuration.
- **Debug Mode**: Set `VITE_DEBUG_MODE=true` in `frontend/.env` to enable debug features:
- **Stores, no Providers**: The code base favours Stores over react Provider pattern due to DX and render performance.

## Coding Style & Naming Conventions
- Formatter/Linter: Biome (see `biome.json`). Run it with `pnpm lint` or `pnpm lint:fix`.
- Indentation: 2 spaces; line width: 100; quotes: single; semicolons: as needed; trailing commas: ES5.
- TypeScript-first; keep strict types and meaningful names.
- Type assertions: Avoid `as` type assertions. Prefer type-safe patterns like `Object.assign` for intersection types, factory functions with `satisfies`, or const assertions (`as const`). When unavoidable, isolate assertions in well-documented helper functions.
- Prefer feature-oriented folders; test files near code or under `tests/`.
- Zod v4 only: `import { z } from 'zod'`. However, in backend due to using hono/zod-openapi, `import { z } from '@hono/zod-openapi'` is required.
- camelCase for variables and functions (including constants - no UPPER_CASE), PascalCase for React components. File names should be kebab-case. Language translation keys should be snake_case.
- Documentation: Add JSDoc block comments to all exported functions and components. Keep comments concise (1-3 lines) describing the purpose and key behavior. In backend we usually add a full JSDoc including params and response, in frontend we limit it to 1-3 text lines, unless its complex and critical functionality.
- Storybook: Stories should be placed in a central `stories/` folder within the module (e.g., `frontend/src/modules/ui/stories/` or `frontend/src/modules/common/stories/`), not alongside component files. Name stories `<component-filename>.stories.tsx`.
- Icons: We use lucide icons and import them using Icon suffix, such as `PencilIcon`.
- Code comment: when iterating keep comments intact as they provide valuable history. They should be cleaned only when explicitly requested.
- Console logging: Use `console.log` only for temporary debugging (remove before commit). Use `console.debug` for persistent debug statements as Vite strips them in production builds. For debug-mode-gated logging, use helpers from `~/lib/debug`.


- Links as buttons: For buttons that link to directly targetable online resources, use TanStack Router `<Link>` with `buttonVariants()` instead of `<button>`. Also when the primary action is opening a sheet, if the data targetable by url, allow end-user to open it in a new tab.
- React-compiler: `useMemo`, `useCallback` can be avoided in most cases.
- Translations: All user-facing text in UI must use translation strings via `const { t } = useTranslation()` and `t('common:save_changes')`. Never hardcode text. Translation files are in `locales/en/`.

## Testing
- Framework: Vitest. Typical locations: `tests/` or `*.test.ts` adjacent to source.
- Test modes: `pnpm test:basic` (fast unit tests, no Docker), `pnpm test:core` (PostgreSQL, default), `pnpm test:full` (includes integration tests + CLI).
- Run all: `pnpm test`; per package: `pnpm test` (from that workspace) or package-specific scripts.
- Name tests `*.test.ts`; add integration tests where behavior spans modules.
- Aim for reliable, isolated tests; include minimal setup files when needed.
- See [info/TESTING.md](./TESTING.md) for detailed test mode documentation.

## Commits & Pull Requests
- Use Conventional Commits: `feat:`, `fix:`, `chore:`, `refactor:`; optional scope (e.g., `feat(web): ...`).
- PRs must include: concise description, linked issues (`#123`), screenshots for UI, and passing checks (build, typecheck, lint, tests).
- Keep changes scoped; update docs and `.env.example` when config changes.

## Commands
- `pnpm dev`: Start development with PostgreSQL + CDC Worker (DEV_MODE=full).
- `pnpm dev:core`: Start development with PostgreSQL only (DEV_MODE=core, no CDC).
- `pnpm quick`: Start development with PGlite (DEV_MODE=basic, fast, no Docker).
- `pnpm test`: Run all tests across the monorepo (alias for `pnpm test:core`).
- `pnpm test:basic`: Fast unit tests only (no Docker required).
- `pnpm test:core`: Standard tests with PostgreSQL (requires Docker).
- `pnpm test:full`: Complete test suite including CDC integration tests.
- `pnpm test:update`: Update Vitest snapshots in backend and frontend.
- `pnpm check`: Comprehensive validation. Runs `generate:openapi`, `ts` (type check), and `lint:fix`.
- `pnpm generate`: Generate new Drizzle migrations based on schema changes in `backend/src/db/schema/`.
- `pnpm generate:openapi`: Regenerate backend OpenAPI spec and update the frontend `api.gen` client.
- `pnpm seed`: Seed the database with initial/test data.
- `pnpm diverged`: List files that have diverged from the upstream Cella template.
- `pnpm upstream:pull`: Pull changes from the upstream Cella template (automatically undoes changes in ignored files).
- `pnpm sync`: Orchestrates the full execution flow of the Cella sync CLI (boilerplate/fork sync).
