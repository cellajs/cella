# Cella Agent Guidelines (AGENTS.md)

This document provides instructions and context for AI agents (like Junie, Cursor, Windsurf, etc.) working on the Cella project.

## Project Vision
Cella is a TypeScript template for building collaborative web apps with sync and offline capabilities. 
It prioritizes great UX, modularity, and open standards. OpenAPI is a central part of the architecture.

## Tech Stack
- **Backend**: Node.js (v24), Hono, Drizzle ORM, PostgreSQL (or PGlite for local dev), Scalar (API Docs).
- **Frontend**: React, TanStack Router, TanStack Query, Zustand, Electric Sync, Shadcn UI, Tailwind CSS.
- **Tools**: Pnpm (workspaces), Biome (lint/format), Vitest (testing), Vite.

## Architecture
- **Flat-root Monorepo**:
  - `backend/`: API, DB schemas, migrations, email templates.
  - `frontend/`: React SPA, generated API client, routes, modules.
  - `config/`: Shared configuration for different environments.
  - `locales/`: i18n translation files.
- **Modularity**: Code is organized into modules (e.g., `auth`, `users`, `organizations`) in both `backend/src/modules` and `frontend/src/modules`. Always maintain this structure when adding features.

## Routing
- **Backend (Hono + OpenAPI)**:
  - Routes are defined in `backend/src/modules/<module>/routes.ts` using `createCustomRoute`. This defines the OpenAPI specification (method, path, guard, request/response schemas).
  - Route handlers are implemented in `backend/src/modules/<module>/handlers.ts` using the `.openapi()` method on an `OpenAPIHono` instance.
  - All module handlers are aggregated in `backend/src/routes.ts`.
- **Frontend (TanStack Router)**:
  - Cella uses a **code-based** router organization, **NOT file-based**.
  - Routes are defined in `frontend/src/routes/` as `.tsx` files (e.g., `user-routes.tsx`) but must be manually added to the route tree.
  - They use `createRoute` and are explicitly organized into a tree structure in `frontend/src/routes/route-tree.tsx`.
  - Layouts (like `AppLayout` or `AuthLayout`) are defined in `frontend/src/routes/base-routes.tsx` and serve as parent routes.
  - The router instance is initialized in `frontend/src/lib/router.ts`.

## State Management & API
- **Server State**: Managed by **TanStack Query**. Query options and keys are defined in `frontend/src/modules/<module>/query.ts`. Optimistic updates are a core pattern.
- **Client State**: Managed by **Zustand**. Stores for UI state, user preferences, and global services (like toasts) are in `frontend/src/store/`.
- **API Client**: The frontend uses a client SDK generated by `openapi-ts` located in `frontend/src/api.gen/`. Always use this client for API calls.

## TypeScript
- **Backend**:
  - **Database**: Drizzle schemas are in `backend/src/db/schema/`.
  - **API Validation**: Zod schemas are in `backend/src/modules/<module>/schema.ts` (using `@hono/zod-openapi`).
  - **Circular Dependencies**: `schema-base.ts` files are used for shared base schemas to prevent circular imports.
  - Types are typically inferred from Zod schemas using `z.infer`.
- **Frontend**:
  - **Generated Types**: The source of truth for API types is `frontend/src/api.gen/`, generated by `openapi-ts` from the OpenAPI spec in `backend/openapi.yaml`.
  - **Module Types**: UI-specific types and extensions of generated types are in `frontend/src/modules/<module>/types.ts`.

## Development Rules & Constraints
- **API Client**: The frontend SDK in `frontend/src/api.gen/` is generated from the backend OpenAPI spec. **NEVER modify files in `api.gen` manually.** Run `pnpm generate:openapi` after changing backend routes or schemas.
- **Database**: Drizzle ORM is mandatory. Schema definitions are in `backend/src/db/schema/`. Use `pnpm generate` in the root or backend to create migrations.
- **Linting & Formatting**: Biome is used for code quality. Run `pnpm lint:fix` or `pnpm check` before finishing a task.
- **Testing**: Use Vitest for tests. Ensure existing tests pass and add new ones for features/fixes.
- **Environment**: Check `.env` and `config/default.ts` for configuration.

## Workflow Patterns
- **Sync/Offline**: Leverage Electric Sync for realtime and offline capabilities. Look at the `attachments` module for a reference implementation.
- **Entities**: Entities are categorized into `ContextEntityType` (has memberships, like organizations) and `ProductEntityType` (content-related). See `info/ARCHITECTURE.md` for details.

## Commands
- `pnpm dev`: Start full development environment (Postgres + Electric Sync).
- `pnpm quick`: Start development with PGlite (fast, no docker needed).
- `pnpm test`: Run all tests across the monorepo.
- `pnpm check`: Comprehensive validation. Runs `generate:openapi`, `ts` (type check), and `lint:fix`.
- `pnpm generate`: Generate new Drizzle migrations based on schema changes in `backend/src/db/schema/`.
- `pnpm generate:openapi`: Regenerate the backend OpenAPI spec and update the frontend `api.gen` client.
- `pnpm seed`: Seed the database with initial/test data.
- `pnpm diverged`: List files that have diverged from the upstream Cella template.
- `pnpm upstream:pull`: Pull changes from the upstream Cella template (automatically undoes changes in ignored files).
- `pnpm sync`: Orchestrates the full execution flow of the Cella Sync Engine (boilerplate/fork sync).
